<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Vue App</title>
  <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/@mdi/font@6.x/css/materialdesignicons.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/vuetify@3.4.0/dist/vuetify.min.css" rel="stylesheet">
</head>

<body>
  <div id="app">
    <v-app>
      <div v-if="!isAuthenticated">
        <v-container class="fill-height" fluid>
          <v-row align="center" justify="center">
            <v-col cols="12" sm="8" md="4">
              <v-card>
                <v-card-title>Login</v-card-title>
                <v-card-text>
                  <v-text-field v-model="username" label="Username" class="mb-3"></v-text-field>
                  <v-text-field v-model="password" label="Password" type="password" @keyup.enter="login"></v-text-field>
                  <v-btn color="primary" block @click="login">Login</v-btn>
                </v-card-text>
              </v-card>
            </v-col>
          </v-row>
        </v-container>
      </div>
      <div v-else>
        <v-app-bar app color="primary">
          <v-app-bar-title>Customer Onboarding App</v-app-bar-title>
          <v-spacer></v-spacer>
          <v-btn to="/" variant="text" color="white">Home</v-btn>
          <v-btn to="/about" variant="text" color="white">About</v-btn>
          <v-btn @click="logout" variant="text" color="white">Logout</v-btn>
        </v-app-bar>
        <v-main>
          <v-container fluid>
            <router-view></router-view>
          </v-container>
        </v-main>
      </div>
    </v-app>
  </div>

  <script type="text/x-template" id="home-template">
    <v-container fluid class="pa-0" style="height: calc(100vh - 64px);">
      <v-row no-gutters style="height: 100%;">
        <!-- Chatbot Section -->
        <v-col cols="6" style="height: 100%; border-right: 1px solid #e0e0e0;">
          <div style="height: 100%; display: flex; flex-direction: column;">
            <v-card-title class="bg-primary text-white">AI Assistant</v-card-title>
            <div ref="chatContainer" style="flex: 1; overflow-y: auto; padding: 16px;">
              <div v-for="message in chatMessages" :key="message.id" class="mb-3">
                <v-card :color="message.isUser ? 'blue-lighten-4' : 'grey-lighten-4'" class="pa-3">
                  <div class="text-body-2" style="white-space: pre-wrap;">{{ message.text }}</div>
                </v-card>
              </div>
            </div>
            <v-progress-linear v-if="isLoading" indeterminate color="primary"></v-progress-linear>
            <v-divider></v-divider>
            <div class="pa-3">
              <v-text-field
                v-model="newMessage"
                placeholder="Type your message..."
                @keyup.enter="sendMessage"
                append-inner-icon="mdi-send"
                @click:append-inner="sendMessage"
                variant="outlined"
                density="compact"
              ></v-text-field>
            </div>
          </div>
        </v-col>
        
        <!-- Form Section -->
        <v-col cols="6" style="height: 100%;">
          <div style="height: 100%; overflow-y: auto; padding: 16px;">
            <v-card>
              <v-card-title>File Transfer Onboarding Form</v-card-title>
              <v-card-text>
                <v-form v-model="formValid">
                  <v-text-field ref="flowName" v-model="formData.flowName" label="Flow Name" variant="outlined" class="mb-3" required @blur="onFieldChange('flowName', formData.flowName)"></v-text-field>
                  
                  <v-card class="mb-3" variant="outlined">
                    <v-card-title class="text-h6">Source System Information</v-card-title>
                    <v-card-text>
                      <v-text-field ref="sourceSystem.name" v-model="formData.sourceSystem.name" label="Source System Name" variant="outlined" class="mb-3" required @blur="onFieldChange('sourceSystemName', formData.sourceSystem.name)"></v-text-field>
                      <v-select ref="sourceSystem.environment" v-model="formData.sourceSystem.environment" label="Source Environment" :items="environments" variant="outlined" class="mb-3" required @update:modelValue="onFieldChange('sourceEnvironment', formData.sourceSystem.environment)"></v-select>
                      <v-text-field ref="sourceSystem.owner" v-model="formData.sourceSystem.owner" label="Source System Owner" variant="outlined" class="mb-3" required @blur="onFieldChange('sourceSystemOwner', formData.sourceSystem.owner)"></v-text-field>
                    </v-card-text>
                  </v-card>
                  
                  <v-card class="mb-3" variant="outlined">
                    <v-card-title class="text-h6">Target System Information</v-card-title>
                    <v-card-text>
                      <v-text-field ref="targetSystem.name" v-model="formData.targetSystem.name" label="Target System Name" variant="outlined" class="mb-3" required @blur="onFieldChange('targetSystemName', formData.targetSystem.name)"></v-text-field>
                      <v-select ref="targetSystem.environment" v-model="formData.targetSystem.environment" label="Target Environment" :items="environments" variant="outlined" class="mb-3" required @update:modelValue="onFieldChange('targetEnvironment', formData.targetSystem.environment)"></v-select>
                      <v-text-field ref="targetSystem.owner" v-model="formData.targetSystem.owner" label="Target System Owner" variant="outlined" class="mb-3" required @blur="onFieldChange('targetSystemOwner', formData.targetSystem.owner)"></v-text-field>
                    </v-card-text>
                  </v-card>
                  
                  <v-select ref="transferMethod" v-model="formData.transferMethod" label="Transfer Method" :items="transferMethods" variant="outlined" class="mb-3" required @update:modelValue="onFieldChange('transferMethod', formData.transferMethod)"></v-select>
                  <v-text-field ref="otherTransferMethod" v-if="formData.transferMethod === 'Other'" v-model="formData.otherTransferMethod" label="Other Transfer Method" variant="outlined" class="mb-3" @blur="onFieldChange('otherTransferMethod', formData.otherTransferMethod)"></v-text-field>
                  
                  <v-card class="mb-3" variant="outlined">
                    <v-card-title class="text-h6">Transfer Frequency</v-card-title>
                    <v-card-text>
                      <v-select ref="frequency.type" v-model="formData.frequency.type" label="Frequency Type" :items="frequencyTypes" variant="outlined" class="mb-3" required @update:modelValue="onFieldChange('frequencyType', formData.frequency.type)"></v-select>
                      <v-text-field ref="frequency.customSchedule" v-if="formData.frequency.type === 'Custom'" v-model="formData.frequency.customSchedule" label="Custom Schedule" variant="outlined" class="mb-3" @blur="onFieldChange('customSchedule', formData.frequency.customSchedule)"></v-text-field>
                      <v-text-field ref="frequency.specificTime" v-model="formData.frequency.specificTime" label="Specific Time (HH:MM)" type="time" variant="outlined" class="mb-3" @blur="onFieldChange('specificTime', formData.frequency.specificTime)"></v-text-field>
                      <v-select ref="frequency.dayOfWeek" v-if="formData.frequency.type === 'Weekly'" v-model="formData.frequency.dayOfWeek" label="Day of Week" :items="daysOfWeek" variant="outlined" class="mb-3" @update:modelValue="onFieldChange('dayOfWeek', formData.frequency.dayOfWeek)"></v-select>
                      <v-text-field ref="frequency.dayOfMonth" v-if="formData.frequency.type === 'Monthly'" v-model="formData.frequency.dayOfMonth" label="Day of Month (1-31)" type="number" min="1" max="31" variant="outlined" class="mb-3" @blur="onFieldChange('dayOfMonth', formData.frequency.dayOfMonth)"></v-text-field>
                    </v-card-text>
                  </v-card>
                  
                  <v-card class="mb-3" variant="outlined">
                    <v-card-title class="text-h6">File Information</v-card-title>
                    <v-card-text>
                      <v-text-field ref="fileInformation.fileFormat" v-model="formData.fileInformation.fileFormat" label="File Format" variant="outlined" class="mb-3" required @blur="onFieldChange('fileFormat', formData.fileInformation.fileFormat)"></v-text-field>
                      <v-text-field ref="fileInformation.fileNamingConvention" v-model="formData.fileInformation.fileNamingConvention" label="File Naming Convention" variant="outlined" class="mb-3" required @blur="onFieldChange('fileNamingConvention', formData.fileInformation.fileNamingConvention)"></v-text-field>
                      <v-text-field ref="fileInformation.estimatedFileSize" v-model="formData.fileInformation.estimatedFileSize" label="Estimated File Size" variant="outlined" class="mb-3" required @blur="onFieldChange('estimatedFileSize', formData.fileInformation.estimatedFileSize)"></v-text-field>
                      <v-select ref="fileInformation.compressionFormat" v-model="formData.fileInformation.compressionFormat" label="Compression Format" :items="compressionFormats" variant="outlined" class="mb-3" @update:modelValue="onFieldChange('compressionFormat', formData.fileInformation.compressionFormat)"></v-select>
                      <v-checkbox ref="fileInformation.encryptionRequired" v-model="formData.fileInformation.encryptionRequired" label="Encryption Required" class="mb-3" @update:modelValue="onFieldChange('encryptionRequired', formData.fileInformation.encryptionRequired)"></v-checkbox>
                      <v-select ref="fileInformation.encryptionMethod" v-if="formData.fileInformation.encryptionRequired" v-model="formData.fileInformation.encryptionMethod" label="Encryption Method" :items="encryptionMethods" variant="outlined" class="mb-3" @update:modelValue="onFieldChange('encryptionMethod', formData.fileInformation.encryptionMethod)"></v-select>
                    </v-card-text>
                  </v-card>
                  
                  <v-card class="mb-3" variant="outlined">
                    <v-card-title class="text-h6">File Location</v-card-title>
                    <v-card-text>
                      <v-text-field ref="fileLocation.sourcePath" v-model="formData.fileLocation.sourcePath" label="Source File Path" variant="outlined" class="mb-3" required @blur="onFieldChange('sourcePath', formData.fileLocation.sourcePath)"></v-text-field>
                      <v-text-field ref="fileLocation.targetPath" v-model="formData.fileLocation.targetPath" label="Target File Path" variant="outlined" class="mb-3" required @blur="onFieldChange('targetPath', formData.fileLocation.targetPath)"></v-text-field>
                      <v-text-field ref="fileLocation.credentials.username" v-model="formData.fileLocation.credentials.username" label="Username" variant="outlined" class="mb-3" @blur="onFieldChange('username', formData.fileLocation.credentials.username)"></v-text-field>
                      <v-select ref="fileLocation.credentials.authenticationMethod" v-model="formData.fileLocation.credentials.authenticationMethod" label="Authentication Method" :items="authMethods" variant="outlined" class="mb-3" @update:modelValue="onFieldChange('authenticationMethod', formData.fileLocation.credentials.authenticationMethod)"></v-select>
                    </v-card-text>
                  </v-card>
                  
                  <v-text-field ref="targetServiceDate" v-model="formData.targetServiceDate" label="Target Service Date" type="date" variant="outlined" class="mb-3" required @blur="onFieldChange('targetServiceDate', formData.targetServiceDate)"></v-text-field>
                  
                  <v-card class="mb-3" variant="outlined">
                    <v-card-title class="text-h6">Contact Information</v-card-title>
                    <v-card-text>
                      <v-text-field ref="contactInformation.requestorName" v-model="formData.contactInformation.requestorName" label="Requestor Name" variant="outlined" class="mb-3" required @blur="onFieldChange('requestorName', formData.contactInformation.requestorName)"></v-text-field>
                      <v-text-field ref="contactInformation.requestorEmail" v-model="formData.contactInformation.requestorEmail" label="Requestor Email" type="email" variant="outlined" class="mb-3" required @blur="onFieldChange('requestorEmail', formData.contactInformation.requestorEmail)"></v-text-field>
                      <v-text-field ref="contactInformation.requestorPhone" v-model="formData.contactInformation.requestorPhone" label="Requestor Phone" variant="outlined" class="mb-3" @blur="onFieldChange('requestorPhone', formData.contactInformation.requestorPhone)"></v-text-field>
                      <v-text-field ref="contactInformation.technicalContact" v-model="formData.contactInformation.technicalContact" label="Technical Contact" variant="outlined" class="mb-3" @blur="onFieldChange('technicalContact', formData.contactInformation.technicalContact)"></v-text-field>
                      <v-text-field ref="contactInformation.technicalContactEmail" v-model="formData.contactInformation.technicalContactEmail" label="Technical Contact Email" type="email" variant="outlined" class="mb-3" @blur="onFieldChange('technicalContactEmail', formData.contactInformation.technicalContactEmail)"></v-text-field>
                    </v-card-text>
                  </v-card>
                  
                  <v-select ref="dataClassification" v-model="formData.dataClassification" label="Data Classification" :items="dataClassifications" variant="outlined" class="mb-3" required @update:modelValue="onFieldChange('dataClassification', formData.dataClassification)"></v-select>
                  <v-textarea ref="additionalRequirements" v-model="formData.additionalRequirements" label="Additional Requirements" variant="outlined" class="mb-3" @blur="onFieldChange('additionalRequirements', formData.additionalRequirements)"></v-textarea>
                  
                  <v-btn color="primary" size="large" block @click="submitForm">Submit Request</v-btn>
                </v-form>
              </v-card-text>
            </v-card>
          </div>
        </v-col>
      </v-row>
      
      <!-- Snackbar for notifications -->
      <v-snackbar v-model="showSnackbar" :color="snackbarColor" timeout="4000">
        {{ snackbarMessage }}
        <template v-slot:actions>
          <v-btn variant="text" @click="showSnackbar = false">Close</v-btn>
        </template>
      </v-snackbar>
    </v-container>
  </script>

  <script type="text/x-template" id="about-template">
    <v-container fluid>
      <v-row>
        <v-col cols="12">
          <h1>About Page</h1>
          <p>This is the about page.</p>
        </v-col>
      </v-row>
    </v-container>
  </script>

  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vuetify@3.4.0/dist/vuetify.min.js"></script>
  <script src="https://unpkg.com/vue-router@4/dist/vue-router.global.js"></script>

  <script>
    const { createApp } = Vue;
    const { createRouter, createWebHashHistory } = VueRouter;
    const { createVuetify } = Vuetify;

    const Home = {
      template: '#home-template',
      data() {
        return {
          chatMessages: [
            { id: 1, text: 'Starting agent...', isUser: false }
          ],
          newMessage: '',
          formValid: false,
          formData: {
            flowName: '',
            sourceSystem: { name: '', environment: 'Production', owner: '' },
            targetSystem: { name: '', environment: 'Production', owner: '' },
            transferMethod: 'SFTP',
            otherTransferMethod: '',
            frequency: { type: 'Daily', customSchedule: '', specificTime: '', dayOfWeek: '', dayOfMonth: null },
            fileInformation: { fileFormat: '', fileNamingConvention: '', estimatedFileSize: '', compressionFormat: 'None', encryptionRequired: false, encryptionMethod: '' },
            fileLocation: { sourcePath: '', targetPath: '', credentials: { username: '', authenticationMethod: 'Password' } },
            targetServiceDate: '',
            contactInformation: { requestorName: '', requestorEmail: '', requestorPhone: '', technicalContact: '', technicalContactEmail: '' },
            dataClassification: 'Internal',
            additionalRequirements: ''
          },
          environments: ['Development', 'Test', 'QA', 'UAT', 'Production', 'Other'],
          transferMethods: ['SFTP', 'FTP', 'API', 'Shared Directory', 'AWS S3', 'Azure Blob Storage', 'Other'],
          frequencyTypes: ['One-time', 'On-demand', 'Hourly', 'Daily', 'Weekly', 'Monthly', 'Quarterly', 'Custom'],
          daysOfWeek: ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'],
          compressionFormats: ['None', 'ZIP', 'GZIP', 'TAR', 'Other'],
          encryptionMethods: ['PGP', 'GPG', 'AES', 'Other'],
          authMethods: ['Password', 'SSH Key', 'API Key', 'OAuth', 'Other'],
          dataClassifications: ['Public', 'Internal', 'Confidential', 'Restricted', 'Regulated'],
          previousValues: {},
          showSnackbar: false,
          snackbarMessage: '',
          snackbarColor: 'success',
          isLoading: false
        }
      },
      methods: {
        scrollToBottom() {
          this.$nextTick(() => {
            if (this.$refs.chatContainer) {
              this.$refs.chatContainer.scrollTop = this.$refs.chatContainer.scrollHeight;
            }
          });
        },
        addAgentMessage(text, isUser = false) {
          this.chatMessages.push({ id: Date.now(), text, isUser });
          this.scrollToBottom();
        },
        showMessage(message, color = 'success') {
          this.snackbarMessage = message;
          this.snackbarColor = color;
          this.showSnackbar = true;
        },
        async sendMessage() {
          if (!this.newMessage.trim()) return;
          this.isLoading = true;
          this.addAgentMessage(this.newMessage, true);
          try {
            const response = await fetch(`/api/ask-agent/${this.newMessage}`, {
              method: 'GET',
              headers: { 
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('token')}`
              }
            });
            if (response.ok) {
              const agentResp = await response.json();
              console.log(agentResp);
              this.addAgentMessage(agentResp.answer);
              this.newMessage = '';
            } else {
              this.showMessage('Error sending message to agent', 'error');
            }
          } catch (error) {
            console.error('Error:', error);
            this.showMessage('Error sending message to agent', 'error');
          } finally {
            this.isLoading = false;
          }
        },
        async submitForm() {
          try {
            const response = await fetch('/api/onboarding-request', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(this.formData)
            });
            if (response.ok) {
              this.showMessage('Form submitted successfully!', 'success');
            } else {
              this.showMessage('Error submitting form', 'error');
            }
          } catch (error) {
            console.error('Error:', error);
            this.showMessage('Error submitting form', 'error');
          }
        },
        sendMessage1() {
          if (this.newMessage.trim()) {
            this.chatMessages.push({
              id: Date.now(),
              text: this.newMessage,
              isUser: true
            });
            this.newMessage = '';
            // Simulate AI response
            setTimeout(() => {
              this.chatMessages.push({
                id: Date.now() + 1,
                text: 'Thank you for your message. I\'ll help you with that right away!',
                isUser: false
              });
            }, 1000);
          }
        },
        updateFormField(fieldName, fieldValue) {
          console.log(`Updating field: ${fieldName} with value:`, fieldValue);
          const keys = fieldName.split('.');
          console.log('Field path keys:', keys);
          let target = this.formData;
          for (let i = 0; i < keys.length - 1; i++) {
            target = target[keys[i]];
            console.log(`Navigated to:`, target);
          }
          target[keys[keys.length - 1]] = fieldValue;
          console.log('Form data updated:', this.formData);
          
          // Scroll to the updated field
          this.$nextTick(() => {
            const fieldRef = this.$refs[fieldName];
            if (fieldRef && fieldRef.$el) {
              console.log(`Scrolling to field: ${fieldName}`);
              fieldRef.$el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
          });
        },
        async onFieldChange(fieldName, fieldValue) {
          const oldValue = this.previousValues[fieldName] || '';
          this.previousValues[fieldName] = fieldValue;
          if (oldValue === fieldValue) {
            console.log(`Field unchanged: ${fieldName} - Value: ${fieldValue}`);
          } else {
            console.log(`Field changed: ${fieldName} - Old: ${oldValue}, New: ${fieldValue}`);

            try {
              const response = await fetch('/api/update-form-field', {
                method: 'POST',
                headers: { 
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${localStorage.getItem('token')}`
                },
                body: JSON.stringify({ name: fieldName, value: fieldValue })
              });
              if (response.ok) {
                const agentResp = await response.json();
                console.log(agentResp);
                this.addAgentMessage(agentResp.answer);
              } else {
                this.showMessage('Error sending update to agent', 'error');
              }
            } catch (error) {
              console.error('Error:', error);
              this.showMessage('Error sending update to agent', 'error');
            }


          }
        }
      },
      async created() {
        console.log('Home component created');
        
        // WebSocket connection
        this.ws = new WebSocket(`ws://${window.location.host}/ws`);
        this.ws.onopen = () => {
          // Send token immediately after connection
          let token = localStorage.getItem('token');
          console.log(`WebSocket connection established. Sending token... ${token}`);
          this.ws.send(JSON.stringify({ token }));
        };
        this.ws.onmessage = (event) => {
          const data = JSON.parse(event.data);
          if (data.type === 'update-form') {
            console.log('Received form update:', data.payload);
            const nameVal = JSON.parse(data.payload);
            if (nameVal.name && nameVal.value !== undefined) {
              this.updateFormField(nameVal.name, nameVal.value);
            }
          }
        };
        
        try {
          const response = await fetch('/api/start-agent', {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
          });
          if (response.ok) {
            const agentResp = await response.json();
            console.log(agentResp);
            this.addAgentMessage(agentResp.answer);
          } else {
            this.showMessage('Error asking agent to start asking questions', 'error');
          }
        } catch (error) {
          console.error('Error:', error);
          this.showMessage('Error asking agent to start asking questions', 'error');
        }

      }
    };
    const About = { template: '#about-template' };

    const routes = [
      { path: '/', component: Home },
      { path: '/about', component: About }
    ];

    const router = createRouter({
      history: createWebHashHistory(),
      routes
    });

    const vuetify = createVuetify({
      theme: {
        defaultTheme: 'light'
      }
    });

    createApp({
      data() {
        return {
          isAuthenticated: false,
          username: '',
          password: ''
        }
      },
      methods: {
        async login() {
          try {
            const response = await fetch('/api/login', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ password: this.password })
            });
            if (response.ok) {
              const data = await response.json();
              localStorage.setItem('token', data.token);
              this.isAuthenticated = true;
            }
          } catch (error) {
            console.error('Login failed:', error);
          }
        },
        async logout() {
          try {
            await fetch('/api/logout', {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
              }
            });
          } catch (error) {
            console.error('Logout error:', error);
          }
          localStorage.removeItem('token');
          this.isAuthenticated = false;
          this.password = '';
        }
      },
      created() {
        this.isAuthenticated = !!localStorage.getItem('token');
      }
    })
      .use(router)
      .use(vuetify)
      .mount('#app');
  </script>
</body>

</html>