<div class="page-container">
  <!-- Centered Form Section -->
  <div class="form-section">
    <div class="form-container">
      <mat-card class="main-card">
        <mat-card-content>
          <form [formGroup]="onboardingForm">
            
            <!-- Editable Title Field -->
            <div class="title-section">
              <mat-form-field appearance="outline" class="title-field">
                <input matInput formControlName="formTitle"
                       (focus)="onFieldFocus('formTitle', 'Form Title')"
                       placeholder="Customer Onboarding Form"
                       class="title-input">
              </mat-form-field>
            </div>
            
            <!-- Section 1: Existing Flows -->
            <mat-card class="section-card" formGroupName="existingFlows">
              <mat-card-title class="section-title">Section 1: Existing Flows</mat-card-title>
              <mat-card-content>
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Source Application Name</mat-label>
                  <input matInput formControlName="sourceApplicationName"
                         (focus)="onFieldFocus('existingFlows.sourceApplicationName', 'Source Application Name')">
                </mat-form-field>

                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Target Application Name</mat-label>
                  <input matInput formControlName="targetApplicationName"
                         (focus)="onFieldFocus('existingFlows.targetApplicationName', 'Target Application Name')">
                </mat-form-field>

                <mat-checkbox formControlName="isUsingIODS"
                              (focus)="onFieldFocus('existingFlows.isUsingIODS', 'Using IODS System')"
                              style="margin: 16px 0;">
                  Is using IODS?
                </mat-checkbox>

                <!-- IODS Details (Conditional) -->
                <div *ngIf="isUsingIODS" formGroupName="iodsDetails" 
                     style="margin-left: 20px; border-left: 3px solid #ccc; padding-left: 16px;">
                  <h4>IODS Details</h4>
                  
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Old IODS ID</mat-label>
                    <input matInput formControlName="oldIodsId"
                           (focus)="onFieldFocus('existingFlows.iodsDetails.oldIodsId', 'Old IODS ID')">
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>On Site Server Application Names</mat-label>
                    <input matInput formControlName="onSiteServerNames"
                           (focus)="onFieldFocus('existingFlows.iodsDetails.onSiteServerNames', 'On Site Server Application Names')">
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>File Name</mat-label>
                    <input matInput formControlName="fileName"
                           (focus)="onFieldFocus('existingFlows.iodsDetails.fileName', 'File Name')">
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>File Type</mat-label>
                    <input matInput formControlName="fileType"
                           (focus)="onFieldFocus('existingFlows.iodsDetails.fileType', 'File Type')">
                  </mat-form-field>

            <mat-form-field appearance="outline" class="full-width">
                    <mat-label>IODS Mailbox or Drop Location Name</mat-label>
                    <input matInput formControlName="iodsMailbox"
                           (focus)="onFieldFocus('existingFlows.iodsDetails.iodsMailbox', 'IODS Mailbox or Drop Location Name')">
            </mat-form-field>

                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Pre/Post Transfer Processes</mat-label>
                    <textarea matInput rows="3" formControlName="prePostTransferProcesses"
                              (focus)="onFieldFocus('existingFlows.iodsDetails.prePostTransferProcesses', 'Pre/Post Transfer Processes')"></textarea>
                  </mat-form-field>
                </div>
              </mat-card-content>
            </mat-card>

            <!-- Section 2: Application Information -->
            <mat-card class="section-card" formGroupName="applicationInfo">
              <mat-card-title class="section-title">Section 2: Application Information</mat-card-title>
              <mat-card-content>
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>System Name</mat-label>
                  <input matInput formControlName="systemName"
                         (focus)="onFieldFocus('applicationInfo.systemName', 'System Name')">
                </mat-form-field>

                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Internal or External Application</mat-label>
                  <mat-select formControlName="internalOrExternal"
                              (focus)="onFieldFocus('applicationInfo.internalOrExternal', 'Internal or External Application')">
                    <mat-option *ngFor="let option of internalExternalOptions" [value]="option">{{option}}</mat-option>
                  </mat-select>
                </mat-form-field>

                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Supported Protocols</mat-label>
                  <input matInput formControlName="supportedProtocols"
                         (focus)="onFieldFocus('applicationInfo.supportedProtocols', 'Supported Protocols')">
                </mat-form-field>

                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>System Platform</mat-label>
                  <input matInput formControlName="platform"
                         (focus)="onFieldFocus('applicationInfo.platform', 'System Platform')">
                </mat-form-field>

                <div class="checkbox-group" formArrayName="environments">
                  <label class="group-label">Environments In Scope</label>
                  <mat-checkbox *ngFor="let env of environmentOptions; let i = index"
                                [formControlName]="i"
                                (change)="onEnvironmentChange()"
                                (focus)="onFieldFocus('applicationInfo.environments', 'Environments In Scope')"
                                style="display: block; margin-bottom: 8px;">
                    {{env}}
                  </mat-checkbox>
                </div>

                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Primary Region</mat-label>
                  <mat-select formControlName="primaryRegion"
                              (focus)="onFieldFocus('applicationInfo.primaryRegion', 'Primary Region')">
                    <mat-option *ngFor="let region of regionOptions" [value]="region">{{region}}</mat-option>
                  </mat-select>
                </mat-form-field>

                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Backup Region</mat-label>
                  <mat-select formControlName="backupRegion"
                              (focus)="onFieldFocus('applicationInfo.backupRegion', 'Backup Region')">
                    <mat-option *ngFor="let region of backupRegionOptions" [value]="region">{{region}}</mat-option>
                  </mat-select>
                </mat-form-field>

                <mat-radio-group formControlName="isExternalApplication" class="radio-group">
                  <mat-radio-button [value]="true" 
                                    (focus)="onFieldFocus('applicationInfo.isExternalApplication', 'External Application')">
                    External Application (via External Vendor)
                  </mat-radio-button>
                  <mat-radio-button [value]="false"
                                    (focus)="onFieldFocus('applicationInfo.isExternalApplication', 'Internal Application')">
                    Internal Application
                  </mat-radio-button>
                </mat-radio-group>
              </mat-card-content>
            </mat-card>

            <!-- Section 3: Network Boundary and Cloud Boundary -->
            <mat-card class="section-card" formGroupName="networkCloudInfo">
              <mat-card-title class="section-title">Section 3: Network Boundary and Cloud Boundary</mat-card-title>
              <mat-card-content>
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Network Location</mat-label>
                  <mat-select formControlName="networkLocation"
                              (focus)="onFieldFocus('networkCloudInfo.networkLocation', 'Network Location')">
                    <mat-option *ngFor="let location of networkLocationOptions" [value]="location">{{location}}</mat-option>
                  </mat-select>
                </mat-form-field>

                <!-- Cloud Details (Conditional) -->
                <div *ngIf="isCloudLocation" formGroupName="cloudDetails" 
                     style="margin-left: 20px; border-left: 3px solid #ccc; padding-left: 16px;">
                  <h4>Cloud Details</h4>
                  
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>AWS Cloud Account Name</mat-label>
                    <input matInput formControlName="awsAccountName"
                           (focus)="onFieldFocus('networkCloudInfo.cloudDetails.awsAccountName', 'AWS Cloud Account Name')">
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>AWS Cloud Account Number</mat-label>
                    <input matInput formControlName="awsAccountNumber"
                           (focus)="onFieldFocus('networkCloudInfo.cloudDetails.awsAccountNumber', 'AWS Cloud Account Number')">
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Cloud Region Name</mat-label>
                    <input matInput formControlName="cloudRegion"
                           (focus)="onFieldFocus('networkCloudInfo.cloudDetails.cloudRegion', 'Cloud Region Name')">
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>AWS Cloud ID</mat-label>
                    <input matInput formControlName="awsCloudId"
                           (focus)="onFieldFocus('networkCloudInfo.cloudDetails.awsCloudId', 'AWS Cloud ID')">
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Server Name</mat-label>
                    <input matInput formControlName="serverName"
                           (focus)="onFieldFocus('networkCloudInfo.cloudDetails.serverName', 'Server Name')">
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>IP or Subnet</mat-label>
                    <input matInput formControlName="ipOrSubnet"
                           (focus)="onFieldFocus('networkCloudInfo.cloudDetails.ipOrSubnet', 'IP or Subnet')">
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Application Target</mat-label>
                    <input matInput formControlName="applicationTarget"
                           (focus)="onFieldFocus('networkCloudInfo.cloudDetails.applicationTarget', 'Application Target')">
                  </mat-form-field>
                </div>

                <mat-checkbox formControlName="requiresExternalVendorConnection"
                              (change)="onFieldChange('networkCloudInfo.requiresExternalVendorConnection', $event.checked)"
                              (focus)="onFieldFocus('networkCloudInfo.requiresExternalVendorConnection', 'Requires External Vendor Connection')"
                              style="margin-top: 16px;">
                  Requires External Vendor Connection?
                </mat-checkbox>
              </mat-card-content>
            </mat-card>

            <!-- Section 4: File Transfer Information (Cloud) -->
            <mat-card class="section-card" formGroupName="fileTransferInfo">
              <mat-card-title class="section-title">Section 4: File Transfer Information (Cloud)</mat-card-title>
              <mat-card-content>
                <mat-checkbox formControlName="hasOutbound"
                              (change)="onFieldChange('fileTransferInfo.hasOutbound', $event.checked)"
                              (focus)="onFieldFocus('fileTransferInfo.hasOutbound', 'Outbound Request (Cloud to On Site)')"
                              style="margin-bottom: 16px;">
                  Outbound Request (Cloud to On Site)?
                </mat-checkbox>

                <!-- Outbound Fields (Conditional) -->
                <div *ngIf="hasOutbound" style="margin-left: 20px; border-left: 3px solid #ccc; padding-left: 16px;">
                  <h4>Outbound Transfer Details</h4>
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Source AWS Account</mat-label>
                    <input matInput formControlName="sourceAwsAccount"
                           (focus)="onFieldFocus('fileTransferInfo.sourceAwsAccount', 'Source AWS Account')">
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Source Bucket ARN</mat-label>
                    <input matInput formControlName="sourceBucketArn"
                           (focus)="onFieldFocus('fileTransferInfo.sourceBucketArn', 'Source Bucket ARN')">
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Source Archive Bucket</mat-label>
                    <input matInput formControlName="sourceArchiveBucket"
                           (focus)="onFieldFocus('fileTransferInfo.sourceArchiveBucket', 'Source Archive Bucket')">
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Source Archive Prefix</mat-label>
                    <input matInput formControlName="sourceArchivePrefix"
                           (focus)="onFieldFocus('fileTransferInfo.sourceArchivePrefix', 'Source Archive Prefix')">
                  </mat-form-field>
                </div>

                <mat-checkbox formControlName="hasInbound"
                              (change)="onFieldChange('fileTransferInfo.hasInbound', $event.checked)"
                              (focus)="onFieldFocus('fileTransferInfo.hasInbound', 'Inbound Request (On Site to Cloud)')"
                              style="margin: 16px 0;">
                  Inbound Request (On Site to Cloud)?
                </mat-checkbox>

                <!-- Inbound Fields (Conditional) -->
                <div *ngIf="hasInbound" style="margin-left: 20px; border-left: 3px solid #ccc; padding-left: 16px;">
                  <h4>Inbound Transfer Details</h4>
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Target Bucket</mat-label>
                    <input matInput formControlName="targetBucket"
                           (focus)="onFieldFocus('fileTransferInfo.targetBucket', 'Target Bucket')">
                </mat-form-field>

                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Target Prefix</mat-label>
                    <input matInput formControlName="targetPrefix"
                           (focus)="onFieldFocus('fileTransferInfo.targetPrefix', 'Target Prefix')">
                  </mat-form-field>
                </div>
              </mat-card-content>
            </mat-card>

            <!-- Section 5: Environment Information -->
            <mat-card class="section-card" formGroupName="environmentInfo">
              <mat-card-title class="section-title">Section 5: Environment Information</mat-card-title>
              <mat-card-content>
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Customer Environments In Scope</mat-label>
                  <textarea matInput rows="3" formControlName="customerEnvironments"
                            (focus)="onFieldFocus('environmentInfo.customerEnvironments', 'Customer Environments In Scope')"></textarea>
                </mat-form-field>

                <div formGroupName="cloudEnvironmentMapping">
                  <h4>Cloud Environment Mapping</h4>
                  
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>DEV maps to</mat-label>
                    <mat-select formControlName="development"
                                (focus)="onFieldFocus('environmentInfo.cloudEnvironmentMapping.development', 'DEV maps to')">
                      <mat-option *ngFor="let option of environmentOptions" [value]="option">{{option}}</mat-option>
                    </mat-select>
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>QA maps to</mat-label>
                    <mat-select formControlName="qualityAssurance"
                                (focus)="onFieldFocus('environmentInfo.cloudEnvironmentMapping.qualityAssurance', 'QA maps to')">
                      <mat-option *ngFor="let option of environmentOptions" [value]="option">{{option}}</mat-option>
                  </mat-select>
                </mat-form-field>

                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>PROD maps to</mat-label>
                    <mat-select formControlName="production"
                                (focus)="onFieldFocus('environmentInfo.cloudEnvironmentMapping.production', 'PROD maps to')">
                      <mat-option *ngFor="let option of environmentOptions" [value]="option">{{option}}</mat-option>
                    </mat-select>
                  </mat-form-field>
                </div>
              </mat-card-content>
            </mat-card>

            <!-- Section 6: Business Information -->
            <mat-card class="section-card" formGroupName="businessInfo">
              <mat-card-title class="section-title">Section 6: Business Information</mat-card-title>
              <mat-card-content>
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Implementation Deadline</mat-label>
                  <input matInput [matDatepicker]="picker" formControlName="implementationDeadline"
                         (dateChange)="onFieldChange('businessInfo.implementationDeadline', $event.value)"
                         (focus)="onFieldFocus('businessInfo.implementationDeadline', 'Implementation Deadline')">
                  <mat-hint>Various formats supported (MM/DD/YYYY, YYYY-MM-DD, etc.)</mat-hint>
                  <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
                  <mat-datepicker #picker></mat-datepicker>
                </mat-form-field>

                <div formGroupName="contacts">
                  <h4>Contact Information</h4>
                  
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Business Contact (Source)</mat-label>
                    <input matInput formControlName="businessContactSource"
                           (focus)="onFieldFocus('businessInfo.contacts.businessContactSource', 'Business Contact (Source)')">
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Technical Contact (Source)</mat-label>
                    <input matInput formControlName="technicalContactSource"
                           (focus)="onFieldFocus('businessInfo.contacts.technicalContactSource', 'Technical Contact (Source)')">
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Business Contact (Target)</mat-label>
                    <input matInput formControlName="businessContactTarget"
                           (focus)="onFieldFocus('businessInfo.contacts.businessContactTarget', 'Business Contact (Target)')">
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Technical Contact (Target)</mat-label>
                    <input matInput formControlName="technicalContactTarget"
                           (focus)="onFieldFocus('businessInfo.contacts.technicalContactTarget', 'Technical Contact (Target)')">
                  </mat-form-field>

                  <mat-form-field *ngIf="requiresExternalVendorConnection" appearance="outline" class="full-width">
                    <mat-label>Vendor Contact (if External)</mat-label>
                    <input matInput formControlName="vendorContact"
                           (focus)="onFieldFocus('businessInfo.contacts.vendorContact', 'Vendor Contact (if External)')">
                  </mat-form-field>
                </div>
              </mat-card-content>
            </mat-card>

            <!-- Submit Button Section -->
            <mat-card class="submit-section">
              <mat-card-content>
                <div class="submit-button-container">
                  <button mat-raised-button 
                          color="primary" 
                          [disabled]="!isFormValid || isSubmitting"
                          (click)="submitForm()"
                          class="submit-button">
                    <mat-icon *ngIf="isSubmitting">hourglass_empty</mat-icon>
                    <span *ngIf="!isSubmitting">Submit Onboarding Request</span>
                    <span *ngIf="isSubmitting">Submitting...</span>
                  </button>
                  <div class="form-validation-message" *ngIf="!isFormValid">
                    <mat-icon>info</mat-icon>
                    <span>Please fill in all required fields marked with * to submit the form.</span>
                  </div>
                </div>
              </mat-card-content>
            </mat-card>

          </form>
        </mat-card-content>
      </mat-card>
    </div>
  </div>

  <!-- Floating Chat Overlay -->
  <div class="chat-overlay" [class.expanded]="chatExpanded">
    <div class="chat-header" (click)="toggleChat()">
      <mat-icon>{{chatExpanded ? 'expand_more' : 'chat'}}</mat-icon>
      <span *ngIf="!chatExpanded">AI Assistant</span>
      <span *ngIf="chatExpanded">AI Assistant - Click to minimize</span>
    </div>
    
    <div class="smart-guide-toggle" *ngIf="chatExpanded">
      <mat-slide-toggle 
        [(ngModel)]="smartGuideEnabled"
        (change)="onSmartGuideToggle($event.checked)"
        color="primary">
        <span class="toggle-label">Smart Guide</span>
      </mat-slide-toggle>
      <mat-icon 
        class="info-icon" 
        matTooltip="When enabled, AI provides context and requirements when you click on form fields. When disabled, AI only responds to your questions (Manual mode)."
        matTooltipPosition="left">
        info_outline
      </mat-icon>
    </div>
    
    <div class="chat-content" *ngIf="chatExpanded">
      <div class="chat-messages" #chatMessagesContainer>
        <div *ngFor="let message of chatMessages; let i = index" class="message-card"
             [ngClass]="{'user-message': message.isUser, 'ai-message': !message.isUser}">
          <div class="message-text">{{message.text}}</div>
          <div class="message-time">{{message.timestamp | date:'short'}}</div>
          
          <!-- Yes/No buttons for welcome message -->
          <div *ngIf="!message.isUser && i === 0 && showWelcomeButtons" class="welcome-buttons">
            <button color="primary" (click)="onWelcomeButtonClick(true)" class="welcome-btn">
              Yes, I'd like assistance
            </button>
            <button color="accent" (click)="onWelcomeButtonClick(false)" class="welcome-btn">
              No, I'll do it myself
            </button>
          </div>
        </div>
        
        <div *ngIf="isLoading" class="message-card ai-message">
          <mat-progress-bar mode="indeterminate"></mat-progress-bar>
          <div class="message-text">AI is thinking...</div>
        </div>
      </div>
      
      <div class="chat-input">
        <mat-form-field appearance="outline">
          <mat-label>Type your message</mat-label>
          <input matInput [(ngModel)]="newMessage" 
                 (keydown)="onEnterKeyPress($event)"
                 [disabled]="isLoading">
          <button mat-icon-button subScriptSizing="dynamic" matSuffix (click)="sendMessage()" [disabled]="isLoading || !newMessage.trim()">
            <mat-icon>send</mat-icon>
          </button>
        </mat-form-field>
      </div>
    </div>
  </div>
</div> 